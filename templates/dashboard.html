{% extends "base.html" %}

{% block title %}Dashboard - BetterGovPH Open Monitoring{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header Stats -->
    <div class="bg-white p-6 rounded-lg shadow">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
        <div>
          <div id="total-count" class="text-3xl font-bold text-blue-600">{{ subdomains|length }}</div>
          <div class="text-sm text-gray-600">Projects Monitored</div>
        </div>
        <div>
          <div id="up-count" class="text-3xl font-bold text-green-600">{{ subdomains|selectattr('up', 'equalto', true)|list|length }}</div>
          <div class="text-sm text-gray-600">Currently Up</div>
        </div>
        <div>
          <div class="text-3xl font-bold text-gray-600">{{ total_agents }}</div>
          <div class="text-sm text-gray-600">Total Agents</div>
        </div>
            <div class="cursor-pointer hover:bg-purple-50 rounded-lg p-2 transition-colors" onclick="showAllDiscoveries()">
              <div class="text-3xl font-bold text-purple-600" id="dns-count">{{ dns_discoveries_count or 0 }}</div>
              <div class="text-sm text-gray-600">All Discoveries</div>
            </div>
      </div>
    </div>

    <!-- Project Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for subdomain in subdomains %}
      <div class="monitoring-card cursor-pointer hover:shadow-lg transition-shadow"
           onclick="showTimeSeries('{{ subdomain.subdomain }}')">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold text-lg truncate">{{ subdomain.subdomain }}</h3>
          <span class="px-2 py-1 rounded-full text-xs font-medium
            {% if subdomain.up %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
            {{ 'UP' if subdomain.up else 'DOWN' }}
          </span>
        </div>

        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-gray-600">Platform:</span>
            <span class="font-medium">{{ subdomain.platform or 'Unknown' }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Uptime (24h):</span>
            <span class="font-medium" data-uptime>{{ "%.1f"|format(subdomain.uptime_percentage) }}%</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Response:</span>
            <span class="font-medium">
              {% if subdomain.response_time_ms %}
                {{ "%.0f"|format(subdomain.response_time_ms) }}ms
              {% else %}
                N/A
              {% endif %}
            </span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Last Check:</span>
            <span class="font-medium text-xs">
              {% if subdomain.last_check_utc8 %}
                {{ subdomain.last_check_utc8.strftime('%H:%M UTC+8') }}
              {% else %}
                Never
              {% endif %}
            </span>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Time Series Modal -->
    <div id="timeseries-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
      <div class="flex items-start justify-center min-h-screen p-4 pt-20">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-screen overflow-hidden">
          <div class="p-6 border-b">
            <div class="flex justify-between items-center">
              <h3 class="text-xl font-bold" id="modal-title">Time Series</h3>
              <button onclick="closeTimeSeries()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
          </div>
          <div class="p-6">
            <div id="timeseries-chart" class="w-full h-96">
              <div class="flex items-center justify-center h-full">
                <div class="text-gray-500">Loading time series data...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
</div>

<!-- DNS Discoveries Modal -->
<div id="dns-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-start justify-center min-h-screen p-4 pt-20">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[calc(100vh-6rem)] mt-4 flex flex-col">
      <div class="p-6 border-b flex-shrink-0">
        <div class="flex justify-between items-center">
          <h3 class="text-xl font-bold">All Discovered Subdomains</h3>
          <button onclick="closeDiscoveriesModal()" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
      <div class="p-6 flex-shrink-0">
        <div class="mb-4">
          <p class="text-gray-600">This table shows all discovered subdomains, including active projects and DNS discoveries. "Inactive Discovery" entries are subdomains found via DNS enumeration that aren't actively monitored projects. "Up/Down" entries are project subdomains that are currently not responding.</p>
        </div>
      </div>
      <div id="dns-table" class="overflow-x-auto overflow-y-auto flex-1 px-6 pb-6">
          <div class="flex items-center justify-center h-32">
            <div class="text-gray-500">Loading DNS discoveries...</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Global variable to store current time range (in hours)
let currentTimeRange = 24;
let currentSubdomain = '';

async function showTimeSeries(subdomain) {
    console.log('showTimeSeries called for:', subdomain, 'currentTimeRange:', currentTimeRange);
    const modal = document.getElementById('timeseries-modal');
    const title = document.getElementById('modal-title');
    const chart = document.getElementById('timeseries-chart');

    currentSubdomain = subdomain;
    title.textContent = `Time Series - ${subdomain}`;
    chart.innerHTML = `
        <div class="flex items-center justify-center h-full">
            <div class="text-gray-500">Loading time series data...</div>
        </div>
    `;
    modal.classList.remove('hidden');

    try {
        const response = await fetch(`/api/subdomains/${subdomain}/checks`);
        const data = await response.json();

        if (data.checks && data.checks.length > 0) {
            renderTimeSeriesChart(data.checks, subdomain, currentTimeRange);
        } else {
            const chartContainer = document.getElementById('timeseries-chart');
            chartContainer.innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <div class="text-gray-500">No time series data available</div>
                </div>
            `;
        }
    } catch (error) {
        const chartContainer = document.getElementById('timeseries-chart');
        chartContainer.innerHTML = `
            <div class="flex items-center justify-center h-full">
                <div class="text-red-500">Error loading data</div>
            </div>
        `;
    }
}

function changeTimeRange(hours) {
    console.log('changeTimeRange called with hours:', hours);
    currentTimeRange = hours;
    console.log('currentTimeRange set to:', currentTimeRange);
    if (currentSubdomain) {
        console.log('Calling showTimeSeries for:', currentSubdomain);
        showTimeSeries(currentSubdomain);
    }
}

function closeTimeSeries() {
    const modal = document.getElementById('timeseries-modal');
    modal.classList.add('hidden');
}

function renderTimeSeriesChart(checks, subdomain, hours = 24) {
    console.log('renderTimeSeriesChart called with hours:', hours, 'for subdomain:', subdomain);
    const chartContainer = document.getElementById('timeseries-chart');
    chartContainer.innerHTML = '';

    // Filter checks by time range
    const now = new Date();
    const cutoffTime = new Date(now.getTime() - (hours * 60 * 60 * 1000));
    const filteredChecks = checks.filter(check => new Date(check.time) >= cutoffTime);

    // Group checks by location
    const locationData = {};
    filteredChecks.forEach(check => {
        const location = check.location || 'EU';
        if (!locationData[location]) {
            locationData[location] = [];
        }
        locationData[location].push({
            time: new Date(check.time),
            responseTime: check.response_time_ms || 0,
            status: check.status_code
        });
    });

    // Debug: Show what locations we have
    console.log('Available locations:', Object.keys(locationData));
    console.log('Location data counts:', Object.keys(locationData).map(loc => `${loc}: ${locationData[loc].length}`));

    // Prioritize SG as bars, then EU as lines
    const locationOrder = ['SG', 'EU', 'PH'];
    const sortedLocations = Object.keys(locationData).sort((a, b) => {
        const indexA = locationOrder.indexOf(a);
        const indexB = locationOrder.indexOf(b);
        return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
    });

    // Prepare data for D3.js
    const dataPoints = 15; // Show last 15 points
    const chartData = [];

    sortedLocations.forEach((location, index) => {
        const data = locationData[location];
        const colorMap = {
            'EU': '#3b82f6', // blue
            'SG': '#10b981', // green
            'PH': '#ef4444'  // red
        };
        const color = colorMap[location] || '#6b7280';

        data.slice(-dataPoints).forEach((point, dataIndex) => {
            chartData.push({
                location: location,
                time: point.time,
                responseTime: point.responseTime,
                color: color,
                type: index === 0 ? 'bar' : 'line'
            });
        });
    });

    // Create D3.js chart
    const width = 800;
    const height = 300;
    const margin = { top: 20, right: 20, bottom: 40, left: 60 };

    const svg = d3.select('#timeseries-chart')
        .append('svg')
        .attr('width', width)
        .attr('height', height)
        .attr('viewBox', `0 0 ${width} ${height}`);

    // Time scale
    const timeExtent = d3.extent(filteredChecks, d => new Date(d.time));
    const xScale = d3.scaleTime()
        .domain(timeExtent)
        .range([margin.left, width - margin.right]);

    // Response time scale
    const responseExtent = d3.extent(filteredChecks, d => d.response_time_ms || 0);
    const yScale = d3.scaleLinear()
        .domain([0, Math.max(responseExtent[1], 1000)])
        .range([height - margin.bottom, margin.top]);

    // Color scale
    const colorScale = d3.scaleOrdinal()
        .domain(sortedLocations)
        .range(['#10b981', '#3b82f6', '#ef4444']);

    // Add axes
    svg.append('g')
        .attr('transform', `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(xScale).ticks(5).tickFormat(d3.timeFormat('%H:%M')));

    svg.append('g')
        .attr('transform', `translate(${margin.left},0)`)
        .call(d3.axisLeft(yScale).tickFormat(d => `${d}ms`));

    // Add chart title
    const timeLabel = hours === 24 ? '24 hours' : hours === 1 ? '1 hour' : '5 minutes';
    svg.append('text')
        .attr('x', width / 2)
        .attr('y', margin.top / 2)
        .attr('text-anchor', 'middle')
        .attr('class', 'text-sm font-medium text-gray-600')
        .text(`Response Time Comparison (last ${timeLabel})`);

    // Group data by location for lines
    const locationGroups = d3.groups(chartData, d => d.location);

    locationGroups.forEach(([location, data]) => {
        // Create line for this location
        const line = d3.line()
            .x(d => xScale(d.time))
            .y(d => yScale(d.responseTime))
            .curve(d3.curveMonotoneX);

        // Add the line path
        svg.append('path')
            .datum(data)
            .attr('fill', 'none')
            .attr('stroke', colorScale(location))
            .attr('stroke-width', 2)
            .attr('d', line);

        // Add dots for data points
        svg.selectAll(`.dot-${location}`)
            .data(data)
            .enter()
            .append('circle')
            .attr('class', `dot-${location}`)
            .attr('cx', d => xScale(d.time))
            .attr('cy', d => yScale(d.responseTime))
            .attr('r', 3)
            .attr('fill', d => d.responseTime > 1000 ? '#f87171' : d.responseTime > 500 ? '#fbbf24' : colorScale(location))
            .append('title')
            .text(d => `${d.responseTime}ms at ${d.time.toLocaleTimeString()} (${location})`);
    });

    // Add legend
    const legend = svg.selectAll('.legend')
        .data(sortedLocations)
        .enter()
        .append('g')
        .attr('class', 'legend')
        .attr('transform', (d, i) => `translate(${width - margin.right - 100},${margin.top + i * 20})`);

    legend.append('line')
        .attr('x1', 0)
        .attr('x2', 20)
        .attr('y1', 10)
        .attr('y2', 10)
        .attr('stroke', d => colorScale(d))
        .attr('stroke-width', 2);

    legend.append('circle')
        .attr('cx', 10)
        .attr('cy', 10)
        .attr('r', 3)
        .attr('fill', d => colorScale(d));

    legend.append('text')
        .attr('x', 25)
        .attr('y', 15)
        .attr('class', 'text-xs')
        .text(d => `${d} (Lines)`);
}

// Close modal when clicking outside
document.getElementById('timeseries-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeTimeSeries();
    }
});

async function showAllDiscoveries() {
    const modal = document.getElementById('dns-modal');
    const tableContainer = document.getElementById('dns-table');

    tableContainer.innerHTML = '<div class="flex items-center justify-center h-32"><div class="text-gray-500">Loading all discoveries...</div></div>';
    modal.classList.remove('hidden');

    try {
        const response = await fetch('/api/dns-discoveries');
        const data = await response.json();

        // Update the count in the dashboard
        const countElement = document.getElementById('dns-count');
        if (countElement && data.count !== undefined) {
            countElement.textContent = data.count;
        }

        if (data.discoveries && data.discoveries.length > 0) {
            let tableHtml = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subdomain</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Discovery Method</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Platform</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Seen</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;
            data.discoveries.forEach(discovery => {
                // For DNS discoveries, status is based on active column (false = inactive discovery)
                // For inactive subdomains, status is based on is_up (current up/down status)
                const isActiveDiscovery = discovery.active;
                const isCurrentlyUp = discovery.is_up !== undefined ? discovery.is_up : false;
                const statusColor = isActiveDiscovery ? (isCurrentlyUp ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800') : 'bg-gray-100 text-gray-800';
                const statusText = isActiveDiscovery ? (isCurrentlyUp ? 'Up' : 'Down') : 'Inactive Discovery';
                tableHtml += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${discovery.subdomain}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${discovery.discovery_method || 'Unknown'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${discovery.platform || 'Unknown'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${discovery.last_seen ? new Date(discovery.last_seen).toLocaleString() : 'Never'}</td>
                    </tr>
                `;
            });
            tableHtml += `</tbody></table>`;
            tableContainer.innerHTML = tableHtml;
        } else {
            tableContainer.innerHTML = '<div class="flex items-center justify-center h-32"><div class="text-gray-500">No discoveries found.</div></div>';
        }
    } catch (error) {
        tableContainer.innerHTML = `<div class="flex items-center justify-center h-32"><div class="text-red-500">Error loading discoveries: ${error.message}</div></div>`;
    }
}

function closeDiscoveriesModal() {
    const modal = document.getElementById('dns-modal');
    modal.classList.add('hidden');
}

// Close modal when clicking outside
document.getElementById('dns-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDiscoveriesModal();
    }
});
</script>
{% endblock %}
